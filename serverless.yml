service: voiceover-api

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1 # Or your preferred region
  stage: dev
  profile: serverless-user
  environment:
    S3_BUCKET_NAME: my-voiceover-uploads-2025 # ðŸ‘ˆ PUT YOUR S3 UPLOAD BUCKET NAME HERE
    DYNAMODB_TABLE_NAME: Voiceovers # ðŸ‘ˆ PUT YOUR DYNAMODB TABLE NAME HERE

  # Grant your Lambda function permission to access S3 and DynamoDB
  iam:
    role:
      statements:
        - Effect: "Allow"
          Action:
            - "dynamodb:Scan"
            - "dynamodb:PutItem"
          Resource: "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.DYNAMODB_TABLE_NAME}"
        - Effect: "Allow"
          Action:
            - "s3:PutObject"
            - "s3:GetObject"
          Resource: "arn:aws:s3:::${self:provider.environment.S3_BUCKET_NAME}/*"

package:
  patterns:
    # - "!node_modules/**" # Exclude node_modules from the zip (it will be installed by AWS)
    - "!frontend/**"
    - "!.vscode/**"
    - "!.git/**"

functions:
  # 1. Main API Function (Existing)
  api:
    handler: dist/server.handler
    events:
      # Use httpApi for a modern API Gateway (note: CORS is handled by Express/server.ts)
      - httpApi: "*"
      # You can remove the 'cors: true' line here as it won't work for httpApi events

  # 2. New Sync Function (for automation)
  syncS3Metadata:
    handler: dist/syncS3.handler # ðŸ‘ˆ Handler for S3 events
    events:
      - s3:
          bucket: ${self:provider.environment.S3_BUCKET_NAME}
          event: s3:ObjectCreated:*
          existing: true
          rules:
            # Only trigger for MP3 uploads
            - suffix: .mp3
